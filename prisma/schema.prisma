generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  avatar        String?
  currency      String    @default("INR")
  onboarded     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  authenticators   Authenticator[]
  accounts         Account[]
  transactions     Transaction[]
  categories       Category[]
  investments      Investment[]
  investmentTransactions InvestmentTransaction[]
  offlineAssets    OfflineAsset[]
  committees       Committee[]
  goals            Goal[]
  budgets          Budget[]
  liabilities      Liability[]
  fixedDeposits    FixedDeposit[]
  sips             SIP[]
  notifications    Notification[]
  emailConnections EmailConnection[]
  watchlistItems   WatchlistItem[]
  priceAlerts      PriceAlert[]
  pushSubscriptions PushSubscription[]
  recommendationSnapshots RecommendationSnapshot[]
  creditCardPayments CreditCardPayment[]
  subscriptions     Subscription[]
  sipChangeLogs     SIPChangeLog[]
  sipInstallments   SIPInstallment[]
}

model Authenticator {
  id                  String   @id @default(cuid())
  userId              String
  credentialId        String   @unique
  credentialPublicKey Bytes
  counter             BigInt
  transports          String[]
  createdAt           DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailConnection {
  id           String    @id @default(cuid())
  userId       String
  provider     String
  accessToken  String
  refreshToken String?
  email        String
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id       String  @id @default(cuid())
  userId   String
  name     String
  type     String
  balance  Decimal @default(0) @db.Decimal(15, 2)
  currency String  @default("INR")
  icon     String?
  color    String?
  creditLimit Decimal? @db.Decimal(15, 2)

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  creditCardPaymentsFrom CreditCardPayment[] @relation("PaymentFromAccount")
  creditCardPaymentsTo   CreditCardPayment[] @relation("PaymentToCard")
  subscriptions          Subscription[]
}

model Category {
  id     String  @id @default(cuid())
  userId String
  name   String
  icon   String?
  color  String?
  type   String

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets      Budget[]

  @@unique([userId, name, type])
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  accountId   String?
  categoryId  String?
  amount      Decimal  @db.Decimal(15, 2)
  type        String
  description String?
  date        DateTime
  source      String   @default("manual")
  emailRef    String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account?  @relation(fields: [accountId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId, date])
  @@index([userId, type])
  @@index([userId, deletedAt])
}

model Investment {
  id           String    @id @default(cuid())
  userId       String
  symbol       String
  name         String
  type         String
  quantity     Decimal   @db.Decimal(15, 6)
  avgBuyPrice  Decimal   @db.Decimal(15, 2)
  currentPrice Decimal?  @db.Decimal(15, 2)
  currency     String    @default("INR")
  lastUpdated  DateTime?
  createdAt    DateTime  @default(now())
  deletedAt    DateTime?

  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  dividends    Dividend[]
  transactions InvestmentTransaction[]
  migratedFromSips SIP[] @relation("SipMigratedInvestment")

  @@index([userId])
  @@index([userId, deletedAt])
}

model InvestmentTransaction {
  id           String   @id @default(cuid())
  userId       String
  investmentId String
  type         String   // buy, sell, sip, dividend, fee
  quantity     Decimal? @db.Decimal(15, 6)
  price        Decimal? @db.Decimal(15, 4)
  amount       Decimal  @db.Decimal(15, 2)
  fees         Decimal? @db.Decimal(15, 2)
  taxes        Decimal? @db.Decimal(15, 2)
  note         String?
  date         DateTime
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([investmentId, date])
}

model Dividend {
  id           String   @id @default(cuid())
  investmentId String
  amount       Decimal  @db.Decimal(15, 2)
  date         DateTime

  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
}

model OfflineAsset {
  id               String    @id @default(cuid())
  userId           String
  name             String
  type             String
  purchasePrice    Decimal   @db.Decimal(15, 2)
  currentValue     Decimal   @db.Decimal(15, 2)
  appreciationRate Decimal?  @db.Decimal(5, 2)
  purchaseDate     DateTime?
  notes            String?
  createdAt        DateTime  @default(now())

  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents        Document[]
  valuationHistory ValuationHistory[]

  @@index([userId])
}

model ValuationHistory {
  id             String   @id @default(cuid())
  offlineAssetId String
  value          Decimal  @db.Decimal(15, 2)
  date           DateTime

  offlineAsset OfflineAsset @relation(fields: [offlineAssetId], references: [id], onDelete: Cascade)
}

model Document {
  id             String   @id @default(cuid())
  offlineAssetId String
  name           String
  url            String
  uploadedAt     DateTime @default(now())

  offlineAsset OfflineAsset @relation(fields: [offlineAssetId], references: [id], onDelete: Cascade)
}

model Committee {
  id            String   @id @default(cuid())
  userId        String
  name          String
  payoutAmount  Decimal  @db.Decimal(15, 2)
  totalMembers  Int      @default(15)
  startDate     DateTime
  paymentDay    Int      @default(1)
  duration      Int
  status        String   @default("active")
  notes         String?
  createdAt     DateTime @default(now())

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments CommitteePayment[]

  @@index([userId])
}

model CommitteePayment {
  id          String    @id @default(cuid())
  committeeId String
  amount      Decimal?  @db.Decimal(15, 2)
  month       Int
  paid        Boolean   @default(false)
  paidDate    DateTime?

  committee Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
}

model Goal {
  id            String    @id @default(cuid())
  userId        String
  name          String
  targetAmount  Decimal   @db.Decimal(15, 2)
  currentAmount Decimal   @default(0) @db.Decimal(15, 2)
  deadline      DateTime?
  icon          String?
  color         String?
  status        String    @default("active")
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Budget {
  id         String  @id @default(cuid())
  userId     String
  categoryId String
  amount     Decimal @db.Decimal(15, 2)
  month      Int
  year       Int

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, month, year])
}

model Liability {
  id           String    @id @default(cuid())
  userId       String
  name         String
  type         String
  principal    Decimal   @db.Decimal(15, 2)
  outstanding  Decimal   @db.Decimal(15, 2)
  interestRate Decimal   @db.Decimal(5, 2)
  emiAmount    Decimal?  @db.Decimal(15, 2)
  startDate    DateTime
  endDate      DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model FixedDeposit {
  id              String    @id @default(cuid())
  userId          String
  bankName        String
  accountNumber   String?
  principal       Decimal   @db.Decimal(15, 2)
  interestRate    Decimal   @db.Decimal(5, 2)
  compounding     String    @default("quarterly")
  startDate       DateTime
  maturityDate    DateTime
  maturityAmount  Decimal   @db.Decimal(15, 2)
  isAutoRenew     Boolean   @default(false)
  notes           String?
  status          String    @default("active")
  createdAt       DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SIP {
  id            String    @id @default(cuid())
  userId        String
  name          String
  fundName      String
  symbol        String?
  pricingSource String    @default("market") // market | mf_nav
  schemeCode    String?
  schemeName    String?
  amount        Decimal   @db.Decimal(15, 2)
  frequency     String    @default("monthly")
  sipDate       Int       @default(1)
  startDate     DateTime
  endDate       DateTime?
  totalInvested Decimal   @default(0) @db.Decimal(15, 2)
  currentValue  Decimal   @default(0) @db.Decimal(15, 2)
  units         Decimal   @default(0) @db.Decimal(15, 6)
  lastPrice     Decimal?  @db.Decimal(15, 4)
  lastUpdated   DateTime?
  expectedReturn Decimal  @default(12) @db.Decimal(5, 2)
  status        String    @default("active")
  lastDebitDate DateTime?
  linkedInvestmentId String?
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedInvestment Investment? @relation("SipMigratedInvestment", fields: [linkedInvestmentId], references: [id], onDelete: SetNull)
  installments SIPInstallment[]
  changeLogs SIPChangeLog[]

  @@index([userId])
  @@index([userId, status])
  @@index([userId, pricingSource])
  @@index([linkedInvestmentId])
}

model SIPInstallment {
  id        String   @id @default(cuid())
  sipId     String
  userId    String
  dueDate   DateTime
  status    String   // due | paid | skipped | missed
  amount    Decimal  @db.Decimal(15, 2)
  navOrPrice Decimal? @db.Decimal(15, 4)
  units     Decimal? @db.Decimal(15, 6)
  isManual  Boolean  @default(false)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sip  SIP  @relation(fields: [sipId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sipId, dueDate])
  @@index([userId, dueDate])
  @@index([sipId, status])
}

model SIPChangeLog {
  id        String   @id @default(cuid())
  sipId     String
  userId    String
  action    String
  field     String?
  fromValue String?
  toValue   String?
  note      String?
  createdAt DateTime @default(now())

  sip  SIP  @relation(fields: [sipId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sipId, createdAt])
  @@index([userId, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  data      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

model WatchlistItem {
  id        String   @id @default(cuid())
  userId    String
  symbol    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, symbol])
  @@index([userId, createdAt])
}

model PriceAlert {
  id            String    @id @default(cuid())
  userId        String
  symbol        String
  targetPrice   Decimal   @db.Decimal(15, 4)
  direction     String    @default("below")
  status        String    @default("active")
  notifyOnce    Boolean   @default(true)
  cooldownMinutes Int     @default(60)
  lastCheckedAt DateTime?
  triggeredAt   DateTime?
  lastNotifiedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([symbol, status])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model RecommendationSnapshot {
  id        String   @id @default(cuid())
  userId    String
  summary   String
  payload   Json
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model CreditCardPayment {
  id                  String   @id @default(cuid())
  userId              String
  fromAccountId       String
  creditCardAccountId String
  amount              Decimal  @db.Decimal(15, 2)
  date                DateTime
  note                String?
  createdAt           DateTime @default(now())

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromAccount       Account @relation("PaymentFromAccount", fields: [fromAccountId], references: [id], onDelete: Cascade)
  creditCardAccount Account @relation("PaymentToCard", fields: [creditCardAccountId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([fromAccountId, date])
  @@index([creditCardAccountId, date])
}

model Subscription {
  id                 String   @id @default(cuid())
  userId             String
  paymentAccountId   String?
  name               String
  merchant           String?
  amount             Decimal  @db.Decimal(15, 2)
  currency           String   @default("INR")
  cadence            String
  nextDueDate        DateTime
  endDate            DateTime?
  remindDaysBefore   Int      @default(1)
  active             Boolean  @default(true)
  category           String?
  paymentMethodLabel String?
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentAccount Account? @relation(fields: [paymentAccountId], references: [id], onDelete: SetNull)

  @@index([userId, active, nextDueDate])
  @@index([paymentAccountId])
}
